# Network Policies for GIMP Streaming Platform
# Implements zero-trust network security with micro-segmentation

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress: []
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
    - protocol: UDP
      port: 443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-ingress-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  - from: []
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: gimp-streaming
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 3000
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 587
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: session-manager-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: session-manager
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443  # Kubernetes API
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: storage-service-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: storage-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80   # For external storage APIs
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: billing-service-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: billing-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80   # For Stripe API
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: streaming-server-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: streaming-server
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 5901  # VNC
  - from: []  # Allow WebRTC from anywhere
    ports:
    - protocol: UDP
      port: 10000-20000  # WebRTC UDP range
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: UDP
      port: 443
    - protocol: UDP
      port: 19302  # STUN server
    - protocol: TCP
      port: 3478   # TURN server
    - protocol: UDP
      port: 3478   # TURN server
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gimp-pods-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: gimp-session
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: streaming-server
    ports:
    - protocol: TCP
      port: 5901  # VNC
    - protocol: TCP
      port: 22   # SSH for management
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: storage-service
    ports:
    - protocol: TCP
      port: 8080  # For file operations
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80   # For package installation
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: gimp-streaming
    ports:
    - protocol: TCP
      port: 5432
  egress: []
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: gimp-streaming
    ports:
    - protocol: TCP
      port: 6379
  egress: []
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-policy
  namespace: gimp-streaming
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values: [web-client, dashboard, admin-panel]
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 3000
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8080
  - to: []
    ports:
    - protocol: TCP
      port: 443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-network-policy
  namespace: gimp-streaming-monitoring
  labels:
    app.kubernetes.io/name: gimp-streaming
    app.kubernetes.io/component: network-policy
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from: []  # Allow from anywhere for monitoring access
    ports:
    - protocol: TCP
      port: 3000  # Grafana
    - protocol: TCP
      port: 9090  # Prometheus
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: gimp-streaming
    ports:
    - protocol: TCP
      port: 8080  # Scrape application metrics
    - protocol: TCP
      port: 3000  # Scrape frontend metrics
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53