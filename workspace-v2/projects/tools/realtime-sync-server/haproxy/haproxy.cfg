global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log global
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 2s
    option httplog
    option dontlognull
    option redispatch
    retries 3
    maxconn 2000
    default-server init-addr none

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-legends

# Frontend for HTTP traffic
frontend http_frontend
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }

# Frontend for HTTPS traffic
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/sync.codeovertcp.com.pem alpn h2,http/1.1
    mode http

    # HTTP/2 support
    option httplog
    option forwardfor

    # Rate limiting
    stick-table type binary size 1m expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 50 }

    # ACL for WebSocket connections
    acl is_websocket path_beg /socket.io/
    acl is_upgrade hdr(upgrade) -i websocket

    # API health check bypass
    acl is_health path /api/health

    # Route WebSocket connections with different backend
    use_backend websocket_servers if is_websocket is_upgrade

    # Route API calls
    use_backend api_servers if { path_beg /api/ }

    # Default backend
    default_backend api_servers

# Backend for WebSocket connections
backend websocket_servers
    mode http
    balance leastconn
    option httpchk GET /api/health

    # WebSocket specific settings
    option http-use-proxy-header
    option forwardfor except 127.0.0.0/8

    # Server instances
    server sync1 sync-server-1:3001 check inter 5s rise 2 fall 3
    server sync2 sync-server-2:3001 check inter 5s rise 2 fall 3
    server sync3 sync-server-3:3001 check inter 5s rise 2 fall 3

    # Sticky sessions for WebSocket (using source IP)
    stick on src

# Backend for API calls
backend api_servers
    mode http
    balance roundrobin
    option httpchk GET /api/health
    option httplog

    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"

    # Compression
    compression algo gzip
    compression type text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript

    # Server instances with health checks
    server sync1 sync-server-1:3001 check inter 5s rise 2 fall 3
    server sync2 sync-server-2:3001 check inter 5s rise 2 fall 3
    server sync3 sync-server-3:3001 check inter 5s rise 2 fall 3